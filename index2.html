<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汤圆 工程设计在线计算程序</title>
    <link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/metro/easyui.css">
	<link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/icon.css">
    <link rel="stylesheet" href="jquery-easyui-1.10.17/themes/color.css">
	<script src="jquery-easyui-1.10.17/jquery.min.js"></script>
	<script src="jquery-easyui-1.10.17/jquery.easyui.min.js"></script>
    <script src="jquery-easyui-1.10.17/datagrid-cellediting.js"></script>
    <script src="js/pipe.js"></script>
    <script src="js/xsteam.js"></script>
    <script src="js/props.js"></script>
    <script src="js/coolprop.js"></script>
    <script src="js/equipment.js"></script>
    <style>
        #wnav a {
            color: #444;
            text-decoration: none;
        }
        #footer {
            text-align: center;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }
        #footer a{
            color: #999;
            text-decoration: none;
        }
    </style>
</head>
<body class="easyui-layout">
    <div data-options="region:'north'" style="height:50px; background-color: #2d3e50; border: none;">
        <a id="logo" href="./" style="font:25px Arial,'Microsoft YaHei',sans-serif; position: relative; top:10px; left:5px; color: #fff; text-decoration: none;">TangYuan</a>
        <span style="font-style: italic; font-family: 'STXingkai','KaiTi'; position: relative; top:10px; left:25px; color: #fff;">工程设计在线计算程序</span>
    </div>
    <div data-options="region:'south'" style="height:30px; ">
        <div id="footer">
            Copyright © 2013-2023 
            <strong><a href="http://yangfengquan.github.io">汤圆</a></strong>
            &nbsp;<strong><a href="http://http://yangfengquan.github.io">http://yangfengquan.github.io</a></strong>
            &nbsp;All Rights Reserved.
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
        </div>
    </div>
    <div data-options="region:'west',title:'导航菜单',split:true" style="width:200px;">
        <ul id="wnav" class="easyui-tree">
            <li>
                <span>管道</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('pipeDiameter')">管径</a></li>
                    <li><a href="javascript:;" onclick="addtab('pipeVelocity')">管线流速</a></li>
                    <li><a href="javascript:;" onclick="addtab('pipeWeight')">管子重量</a></li>
                    <li><a href="javascript:;" onclick="addtab('pipeSize')">钢管尺寸</a></li>
                    <li><a href="javascript:;" onclick="addtab('pipeStrength')">壁厚</a></li>
                </ul>
            </li>
            <li>
                <span>绝热</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('pipeHInsultion')">管道保温</a></li>
                    <li><a href="javascript:;" onclick="addtab('pipeCInsultion')">管道保冷</a></li>
                </ul>
            </li>
            <li><a href="javascript:;" onclick="addtab('waterpipe')">水和水蒸汽管道</a></li>
            <li>
                <span>物性</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('waterprops')">水和水蒸汽</a></li>
                    <li><a href="javascript:;" onclick="addtab('props')">纯物质</a></li>
                </ul>
            </li>
            <li>
                <span>设备</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('pumpPower')">泵轴功率</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div data-options="region:'center'" style="padding:5px;background:#eee;">
        <a id="link-clac", href="javascript:;" class="easyui-linkbutton c5" data-options="iconCls:'icon-sum'"
            style="margin: 5px auto 5px 10px;" onclick="apiCalc()">运算</a>
        <a id="btn-report" href="javascript:;" class="easyui-linkbutton c2" data-options="iconCls:'icon-print'"
            style="margin: 5px auto 5px 10px;" onclick = "showPdf('${plugin}','${callback}')">生成报告</a>
        <div id="tt" class="easyui-tabs">
            <div title="Welcome" href="Welcome.html" style="padding:20px;display:none;">
            </div>
        </div>
    </div>
<script>
var ApiData, CurPlugin;

(function(){   

    $.when($.getJSON("json/apidata.json",function(data){
        ApiData = data;
    })).done(function(){
        for(let item in ApiData){
            if (item != "tree") {
                ApiData.tree[ApiData[item].pid].children.push({
                    "text": ApiData[item].title,
                    "attributes":{
                        "url": item,
                    }
                })
            }
        }

        $('#wnav').tree({
            data: ApiData.tree,
            onClick: function(node){
                addtab(node.attributes.url);
            }
        })
    })
 
    $('#tt').tabs({
        onSelect: function(title){
            for (let key in ApiData){
                if (ApiData[key].title == title) {
                    CurPlugin = key;
                }
            }
        } 
    });
})();

function addtab(plugin){
    if ($('#tt').tabs('exists', ApiData[plugin].title)){
        $('#tt').tabs('select', ApiData[plugin].title);
    } else {
        $('#tt').tabs('add',{
            title: ApiData[plugin].title,
            href: 'public/' + ApiData[plugin].url +'.html',
            closable:true,
        });
    }
}

function apiCalc() {
    rows = $('#dg-inp-' + CurPlugin).datagrid('getData').rows;
    let res = eval(CurPlugin)(rows);
    // let rows = [];
    // if (plugin == "水和水蒸汽") {
    //     rows[0] = $("#waterpropsargname1").combobox("getValue") 
    //             + $("#waterpropsargname2").combobox("getValue");
    //     rows[1] = parseFloat($("#waterpropsvalue1").numberbox('getValue'));
    //     rows[2] = parseFloat($("#waterpropsvalue2").numberbox('getValue'));
    // }
    // else if (plugin == "纯物质") {
    //     rows[0] = $("#propsfluid").combobox("getText");
    //     rows[1] = $("#propsargname1").combobox("getValue");
    //     rows[2] = parseFloat($("#propsvalue1").numberbox("getValue"));
    //     rows[3] = $("#propsargname2").combobox("getValue");
    //     rows[4] = parseFloat($("#propsvalue2").numberbox("getValue"));
    // }
    // else {
    //     rows = $('#dg-inp-' + plugin).datagrid('getData').rows;
    // }
    
    // let res = eval(CurPlugin)(rows);
    // if (!res) {
    //     return false;
    // }

    // res.forEach((value, i) => {
    //     apiData[plugin].out[i].value = value;
    // })
    
    // showDgout(plugin);
    // return true;
}

function showDgout(plugin) {
    $('#dg-out-' + plugin).datagrid({
        data: apiData[plugin].out
    })
}

function showPdf(plugin, callback) {
    if (['钢管尺寸', '水和水蒸汽', '纯物质'].includes(plugin)) {
        alert(plugin + "模块不支持生成报告。");
        return false;
    }

    if (!apiClac(plugin, callback)) {
        alert("未生成报告！")
        return false;
    }

    if ($('#tt').tabs('exists','report')){
        $('#tt').tabs('select', 'report');
    } else {
        $('#tt').tabs('add',{
            title:'report',
            content: `
            <style>
                #iframeContainer>iframe {
                    width: 98%;
                    height: 98%;
                    position: absolute;
                }
            </style>
            <div id="pdf">
                <div id="iframeContainer">
                    <img style="position: absolute;top: 100px; left: 100px;" src="jquery-easyui-1.10.17/themes/metro/images/loading.gif"/>
                </div>
            </div>`,
            closable:true,
        });
    }

    

    let scriptpdfmake = document.createElement("script");
    scriptpdfmake.src = "./pdfmake/pdfmake.min.js";
    document.querySelector("#pdf").appendChild(scriptpdfmake);
    let scriptvfs_fonts = document.createElement("script");
    scriptvfs_fonts.src = "./pdfmake/vfs_fonts.js";
    document.querySelector("#pdf").appendChild(scriptvfs_fonts);

    const docDefinition = fillDocDefinition(plugin);

    scriptvfs_fonts.onload = function(){
        $('#iframeContainer').html("");
        try {
            pdfMake.fonts = {
                songti: {
                    normal: '长城宋体.TTF',
                    bold: '长城宋体.TTF',
                    italics: '长城宋体.TTF',
                    bolditalics: '长城宋体.TTF'
                }
            }

            pdfMake.createPdf(docDefinition).getDataUrl().then((dataUrl) => {
                const targetElement = document.querySelector('#iframeContainer');
                const iframe = document.createElement('iframe');
                iframe.src = dataUrl;
                targetElement.appendChild(iframe);
                }, err => {
                console.error(err);
            });  
        } catch (error) {
            alert(error + "\n请稍后重试。");
        } 
    }

    return true;
}

function fillDocDefinition(plugin) {
    let time = new Date();
    var  docDefinition = {
        footer: function(currentPage, pageCount) { return {text: currentPage.toString() + ' / ' + pageCount, alignment: 'center'} },
        content: [
            { text: ['软件：',{decoration: 'underline', color: 'blue', text: 'yangfengquan.github.io', link: 'https://yangfengquan.github.io'}], style: 'right' },
            { text: time.toLocaleDateString(), style: 'right' },
            { 
                style: 'tablestyle1',
                table: {
                    widths: [510],
                    heights: [720],
                    body: [[['\n',{ text: '计算报告\n\n', style: 'header' } ]]]
                }
            }
        ],

        styles: {
            header: {
                fontSize: 22,
                alignment: 'center'
            },
            right: {
                alignment: 'right'
            },
            footer: {
                alignment: 'right'
            }
        },
        defaultStyle: {
            font: 'songti'
        }
    };

    let columns = [];
    let len = apiData[plugin].inp.length;
    for (let i = 0; i < len; i++) {
        const item = apiData[plugin].inp[i];
        columns.push({text: item.argName + ': ' + item.value + ' ' + item.unit});
        if (i % 2 != 0 || len - 1 == i) {
            docDefinition.content[2].table.body[0][0].push({columns: columns});
            docDefinition.content[2].table.body[0][0].push('\n');
            columns = [];
        }
    }

    docDefinition.content[2].table.body[0][0].push({text: "---"});
    docDefinition.content[2].table.body[0][0].push('\n');

    let columns1 = [];
    let len1 = apiData[plugin].out.length;
    for (let i = 0; i < len1; i++) {
        const item = apiData[plugin].out[i];
        columns.push({text: item.argName + ': ' + item.value + ' ' + item.unit});
        if (i % 2 != 0 || len1 - 1 == i) {
            docDefinition.content[2].table.body[0][0].push({columns: columns});
            docDefinition.content[2].table.body[0][0].push('\n');
            columns = [];
        }
    }
    
    return docDefinition;
}
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c601c0ade979f55c4e2d64e5eb0eac59";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
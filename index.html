<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汤圆 工程设计在线计算程序</title>
    <link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/metro/easyui.css">
	<link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/icon.css">
    <link rel="stylesheet" href="jquery-easyui-1.10.17/themes/color.css">
	<script src="jquery-easyui-1.10.17/jquery.min.js"></script>
	<script src="jquery-easyui-1.10.17/jquery.easyui.min.js"></script>
    <script src="jquery-easyui-1.10.17/datagrid-cellediting.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.js"></script>
    <script src="js/pipe.js"></script>
    <script src="js/xsteam.js"></script>
    <script src="js/props.js"></script>
    <script src="js/coolprop.js"></script>
    <script src="js/equipment.js"></script>
    <style>
        #wnav a {
            color: #444;
            text-decoration: none;
        }
        #footer {
            text-align: center;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }
        #footer a{
            color: #999;
            text-decoration: none;
        }
    </style>
</head>
<body class="easyui-layout">
    <div data-options="region:'north'" style="height:50px; background-color: #2d3e50; border: none;">
        <a id="logo" href="./" style="font:25px Arial,'Microsoft YaHei',sans-serif; position: relative; top:10px; left:5px; color: #fff; text-decoration: none;">TangYuan</a>
        <span style="font-style: italic; font-family: 'STXingkai','KaiTi'; position: relative; top:10px; left:25px; color: #fff;">工程设计在线计算程序</span>
    </div>
    <div data-options="region:'south'" style="height:30px; ">
        <div id="footer">
            Copyright © 2013-2023 
            <strong><a href="http://yangfengquan.github.io">汤圆</a></strong>
            &nbsp;<strong><a href="http://http://yangfengquan.github.io">http://yangfengquan.github.io</a></strong>
            &nbsp;All Rights Reserved.
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
        </div>
    </div>
    <div data-options="region:'west',title:'导航菜单',split:true" style="width:250px;">
        <ul id="wnav"></ul>
        <br/>
        <ul id="lastlist"  class="easyui-tree"></ul>
    </div>
    <div data-options="region:'center'" style="padding:5px;background:#eee;">
        <input id="fb" type="file" style="display: none;" onchange="openfile()">
        <a  href="javascript:;" class="easyui-linkbutton c2" data-options="iconCls:'icon-save'"
            style="margin: 5px auto 5px 10px;" onclick="save1()">保存</a>
        <a  href="javascript:;" class="easyui-linkbutton c2" data-options="iconCls:'icon-search'"
            style="margin: 5px auto 5px 10px;" onclick="open1()">打开</a>
        <a  href="javascript:;" class="easyui-linkbutton c5" data-options="iconCls:'icon-sum'"
            style="margin: 5px auto 5px 10px;" onclick="tyCalc()">运算</a>
        <a href="javascript:;" class="easyui-linkbutton c2" data-options="iconCls:'icon-print'"
            style="margin: 5px auto 5px 10px;" onclick = "typdf()">生成报告</a>
        <div id="tt" class="easyui-tabs">
            <div title="Welcome" href="Welcome.html" style="padding:20px;display:none;">
            </div>
        </div>
    </div>
<script>
var ApiData, CurPlugin;

(function(){   
    $.when($.getJSON("json/apidata.json",function(data){
        ApiData = data;
    })).done(function(){
        for(let item in ApiData){
            if (item != "tree") {
                ApiData.tree[ApiData[item].pid].children.push({
                    "text": ApiData[item].title,
                    "attributes":{
                        "url": item,
                    }
                })
            }
        }

        $('#wnav').tree({
            data: ApiData.tree,
            onClick: function(node){
                if (!node.hasOwnProperty('children')) {
                    addtab(ApiData[node.attributes.url].title, ApiData[node.attributes.url].url);
                }
            }
        })

        let lasttree = [{
            "id": 0,
            "text": "最近打开的文件",
            "children": []
        }];
        if (localStorage.getItem('lastlist') != null) {
            let lastlist = JSON.parse(localStorage.getItem('lastlist'));
            lastlist.reverse();
            
            lastlist.forEach(item => {
                let ar = item.split('_');
                lasttree[0].children.push({"text": ApiData[ar[0]].title + '_' + ar[1], url: ar[0]});
            });
        }

        $('#lastlist').tree({
            data: lasttree,
            onClick: function(node){
                if (!node.hasOwnProperty('children')) {
                    let t = node.text.split('_')[1];
                    let f = localStorage.getItem(node.url + '_' + t);
                    ApiData[node.url].inp = JSON.parse(f).inp;
                    addtab(ApiData[node.url].title, ApiData[node.url].url);
                }
            }
        });
    });

    $('#tt').tabs({
        onSelect: function(title){
            for (let key in ApiData){
                if (ApiData[key].title == title) {
                    CurPlugin = key;
                }
            }
        },
        onBeforeClose: function(title){
            return confirm('[ ' + title + ' ] 已打开，确定要关闭吗？');
        }
    });
})();

window.onbeforeunload = function(e){
    e.returnValue=('你所做的更改可能未保存。')
}

function save1() {
    if (typeof CurPlugin ==="undefined") {
        return;
    }
    const c = {"plugin": CurPlugin, "inp": ApiData[CurPlugin].inp};
    const cjson = JSON.stringify(c);
    const blob = new Blob([cjson], {type: "application/json; charset=utf-8"});
    saveAs(blob, '新建文件.ty');
    
    let item = CurPlugin + '_' + (new Date()).toLocaleString();
    localStorage.setItem(item , cjson);
    let lastlist = [];
    
    if (Array.isArray(JSON.parse(localStorage.getItem('lastlist')))) {
        lastlist = JSON.parse(localStorage.getItem('lastlist'));
    }
    lastlist.push(item)
    if (lastlist.length > 10) {
        localStorage.removeItem(lastlist[0]);
        lastlist.shift();
    }
    localStorage.setItem('lastlist', JSON.stringify(lastlist));
}


function open1() {
    $('#fb').click();
}

function openfile() {
    //let path = $('#fb').val();
    //console.log($.get(path));
    let file = $('#fb').prop('files')[0];
    console.log(file);
    if (file) {
        const reader = new FileReader();
        reader.readAsText(file, 'utf-8');
        reader.onload = function(evt){
            const fs = evt.target.result;
            
            let o = JSON.parse(fs);console.log(o);
            ApiData[o.plugin].inp = o.inp;
            addtab(ApiData[o.plugin].title, ApiData[o.plugin].url);
        }
    }
}

function addtab(title, url, isclose = false){
    if ($('#tt').tabs('exists', title)){
        $('#tt').tabs('close', title);
    } 
    $('#tt').tabs('add',{
        title: title,
        href: 'public/' + url + '.html',
        closable:true,
    });  
}

function tyCalc() {
    if (typeof CurPlugin ==="undefined") {
        return false;
    }
    let res = eval(CurPlugin)(ApiData[CurPlugin].inp);

    if(res){
        res.forEach((value, i) => {
            ApiData[CurPlugin].out[i].value = value;
        })
        addtab('结果', 'result', true);
        return true;
    }

    return false;
}

function typdf() {
    if (!tyCalc()) {
        alert("未生成报告！")
        return false;
    }

    addtab('PDF', 'pdf', true)
}
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c601c0ade979f55c4e2d64e5eb0eac59";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汤圆 工程设计在线计算程序</title>
    <link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/metro/easyui.css">
	<link rel="stylesheet" type="text/css" href="jquery-easyui-1.10.17/themes/icon.css">
    <link rel="stylesheet" href="jquery-easyui-1.10.17/themes/color.css">
	<script src="jquery-easyui-1.10.17/jquery.min.js"></script>
	<script src="jquery-easyui-1.10.17/jquery.easyui.min.js"></script>
    <script src="jquery-easyui-1.10.17/datagrid-cellediting.js"></script>
    <script src="js/pipe.js"></script>
    <script src="js/xsteam.js"></script>
    <style>
        #wnav a {
            color: #444;
            text-decoration: none;
        }
        #footer {
            text-align: center;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }
        #footer a{
            color: #999;
            text-decoration: none;
        }
    </style>
</head>
<body class="easyui-layout">
    <div data-options="region:'north'" style="height:50px; background-color: #2d3e50; border: none;">
        <a id="logo" href="./" style="font:25px Arial,'Microsoft YaHei',sans-serif; position: relative; top:10px; left:5px; color: #fff; text-decoration: none;">TangYuan</a>
        <span style="font-style: italic; font-family: 'STXingkai','KaiTi'; position: relative; top:10px; left:25px; color: #fff;">工程设计在线计算程序</span>
    </div>
    <div data-options="region:'south'" style="height:30px; ">
        <div id="footer">Copyright © 2013-2023 <strong><a href="http://yangfengquan.github.io">汤圆</a></strong>&nbsp;<strong><a href="http://http://yangfengquan.github.io">http://yangfengquan.github.io</a></strong>&nbsp;All Rights Reserved.</div>
    </div>
    <div data-options="region:'west',title:'导航菜单',split:true" style="width:200px;">
        <ul id="wnav" class="easyui-tree">
            <li>
                <span>管道</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('管径','pipeDiameter')">管径</a></li>
                    <li><a href="javascript:;" onclick="addtab('管线流速','pipeVelocity')">管线流速</a></li>
                    <li><a href="javascript:;" onclick="addtab('管子重量','pipeWeight')">管子重量</a></li>
                    <li><a href="javascript:;" onclick="addtab('钢管尺寸','pipeSize')">钢管尺寸</a></li>
                    <li><a href="javascript:;" onclick="addtab('壁厚','pipeStrength')">壁厚</a></li>
                </ul>
            </li>
            <li>
                <span>绝热</span>
                <ul>
                    <li><a href="javascript:;" onclick="addtab('管道保温','pipeInsultion')">管道保温</a></li>
                    <li><a href="javascript:;" onclick="addtab('管道保冷','pipeInsultion')">管道保冷</a></li>
                </ul>
            </li>
            <li><a href="javascript:;" onclick="addtab('水和水蒸汽管道','waterpipe')">水和水蒸汽管道</a></li>
        </ul>
    </div>
    <div data-options="region:'center'" style="padding:5px;background:#eee;">
        <div id="tt" class="easyui-tabs">
            <div title="Welcome" href="Welcome.html" style="padding:20px;display:none;">
            </div>
        </div>
    </div>
<script>
var apiData;
(function(){
    $.getJSON("json/apidata.json",function(data){
        apiData = data;
    })
})();

function addtab(plugin, callback){
    const linkHtml = `<a href="javascript:;" class="easyui-linkbutton c5" data-options="iconCls:'icon-sum'"
                       style="margin: 5px auto 5px 500px;" onclick="apiClac('${plugin}','${callback}')">运算</a>
                      <a id="btn-report" href="javascript:;" class="easyui-linkbutton c2" data-options="iconCls:'icon-print'"
                       style="margin: 5px auto 5px 10px;" onclick = "showPdf('${plugin}','${callback}')">生成报告</a>`;
    let dgInpHtml = {}
    dgInpHtml["default"] = `<table id="dg-inp-${plugin}" title="输入" style="width:100%; height: auto;">
                                <thead>
                                    <tr>
                                        <th data-options="field:'itemid',width:40">编号</th>
                                        <th data-options="field:'argName',width:100">项目</th>
                                        <th data-options="field:'value',width:200,align:'right',editor:'text'">值</th>
                                        <th data-options="field:'unit',width:80,align:'right'">单位</th>
                                        <th data-options="field:'attr1',width:350,editor:'text'">说明</th>
                                    </tr>
                                </thead>
                            </table>
                            <span class="c1" style="display:block; margin: 5px">注意：请将鼠标移出输入框，点击表格任意位置完成输入。</span>`;
    dgInpHtml["钢管尺寸"] = `<table id="dg-inp-${plugin}" title="输入" style="width:100%; height: auto;">
                                <thead>
                                    <tr>
                                        <th data-options="field:'itemid',width:40">编号</th>
                                        <th data-options="field:'dn',width:100,align:'right',
                                        editor:{
                                            type:'combobox',
                                            options: { 
                                                valueField: 'text',
                                                textField: 'text',
                                                url: './json/dn.json',
                                                method: 'get',
                                            }
                                        }">公称直径</th>
                                        <th data-options="field:'sch',width:200,align:'right',
                                        editor:{
                                            type:'combobox',
                                            options: { 
                                                valueField: 'text',
                                                textField: 'text',
                                                url: './json/sch.json',
                                                method: 'get',
                                            }
                                        }">管表号</th>
                                        <th data-options="field:'attr1',width:350,editor:'text'">说明</th>
                                    </tr>
                                </thead>
                            </table>
                            <span class="c1" style="display:block; margin: 5px">注意：请将鼠标移出输入框，点击表格任意位置完成输入。</span>`;
    const dgOutHtml = `<table id="dg-out-${plugin}" title="输出" style="width:100%; height: auto; display:none">
                            <thead>
                                <tr>
                                    <th data-options="field:'itemid',width:40">编号</th>
                                    <th data-options="field:'argName',width:100">项目</th>
                                    <th data-options="field:'value',width:200,align:'right'">值</th>
                                    <th data-options="field:'unit',width:80,align:'right'">单位</th>
                                    <th data-options="field:'attr1',width:250">说明</th>
                                </tr>
                            </thead>
                        </table>`;
    let content = linkHtml;
    if (dgInpHtml.hasOwnProperty(plugin)) {
        content += dgInpHtml[plugin];
    } else {
        content += dgInpHtml['default'];
    }
    content += dgOutHtml;
    
    if ($('#tt').tabs('exists',plugin)){
        $('#tt').tabs('select', plugin);
    } else {
        $('#tt').tabs('add',{
            title:plugin,
            //href:'api/'+plugin+'.html',
            content: content,
            closable:true,
        });
    }
    $(function(){
        $('#dg-inp-' + plugin).datagrid({
            data: apiData[plugin].inp
        }).datagrid('enableCellEditing').datagrid('gotoCell', {
            index: 0,
            field: 'value'
        });
    });
}

function apiClac(plugin, callback) {
    let rows = $('#dg-inp-' + plugin).datagrid('getData').rows;
    let res = eval(callback)(rows);
    if (!res) {
        return false;
    }
    
    res.forEach((value, i) => {
        apiData[plugin].out[i].value = value;
    })
    
    showDgout(plugin);
    return true;
}

function showDgout(plugin) {
    $('#dg-out-' + plugin).datagrid({
        data: apiData[plugin].out
    })
}

function showPdf(plugin, callback) {
    if (['钢管尺寸'].includes(plugin)) {
        alert(plugin + "模块不支持生成报告。");
        return false;
    }

    if (!apiClac(plugin, callback)) {
        alert("未生成报告！")
        return false;
    }

    if ($('#tt').tabs('exists','report')){
        $('#tt').tabs('select', 'report');
    } else {
        $('#tt').tabs('add',{
            title:'report',
            content: `
            <style>
                #iframeContainer>iframe {
                    width: 98%;
                    height: 98%;
                    position: absolute;
                }
            </style>
            <div id="pdf">
                <div id="iframeContainer"></div>
            </div>`,
            closable:true,
        });
    }

    $('#iframeContainer').innerHTML = "<p>&nbsp正在加载pdf字体文件，请耐心等待。</p>"

    let scriptpdfmake = document.createElement("script");
    scriptpdfmake.src = "./pdfmake/pdfmake.min.js";
    document.querySelector("#pdf").appendChild(scriptpdfmake);
    let scriptvfs_fonts = document.createElement("script");
    scriptvfs_fonts.src = "./pdfmake/vfs_fonts.js";
    document.querySelector("#pdf").appendChild(scriptvfs_fonts);

    const docDefinition = fillDocDefinition(plugin);

    scriptvfs_fonts.onload = function(){
        try {
            pdfMake.fonts = {
                songti: {
                    normal: '长城宋体.TTF',
                    bold: '长城宋体.TTF',
                    italics: '长城宋体.TTF',
                    bolditalics: '长城宋体.TTF'
                }
            }

            pdfMake.createPdf(docDefinition).getDataUrl().then((dataUrl) => {
                const targetElement = document.querySelector('#iframeContainer');
                const iframe = document.createElement('iframe');
                iframe.src = dataUrl;
                targetElement.appendChild(iframe);
                }, err => {
                console.error(err);
            });  
        } catch (error) {
            alert(error + "\n请稍后重试。");
        }
        
    }

    return true;
}

function fillDocDefinition(plugin) {
    let time = new Date();
    var  docDefinition = {
        footer: function(currentPage, pageCount) { return {text: currentPage.toString() + ' / ' + pageCount, alignment: 'center'} },
        content: [
            { text: ['软件：',{text: 'yangfengquan.github.io', link: 'https://yangfengquan.github.io'}], style: 'right' },
            { text: time.toLocaleDateString(), style: 'right' },
            { 
                style: 'tablestyle1',
                table: {
                    widths: [510],
                    heights: [720],
                    body: [[['\n',{ text: '计算报告\n\n', style: 'header' } ]]]
                }
            }
        ],

        styles: {
            header: {
                fontSize: 22,
                alignment: 'center'
            },
            right: {
                alignment: 'right'
            },
            footer: {
                alignment: 'right'
            }
        },
        defaultStyle: {
            font: 'songti'
        }
    };

    let columns = [];
    let len = apiData[plugin].inp.length;
    for (let i = 0; i < len; i++) {
        const item = apiData[plugin].inp[i];
        columns.push({text: item.argName + ': ' + item.value + ' ' + item.unit});
        if (i % 2 != 0 || len - 1 == i) {
            docDefinition.content[2].table.body[0][0].push({columns: columns});
            docDefinition.content[2].table.body[0][0].push('\n');
            columns = [];
        }
    }

    docDefinition.content[2].table.body[0][0].push({text: "---"});
    docDefinition.content[2].table.body[0][0].push('\n');

    let columns1 = [];
    let len1 = apiData[plugin].out.length;
    for (let i = 0; i < len1; i++) {
        const item = apiData[plugin].out[i];
        columns.push({text: item.argName + ': ' + item.value + ' ' + item.unit});
        if (i % 2 != 0 || len1 - 1 == i) {
            docDefinition.content[2].table.body[0][0].push({columns: columns});
            docDefinition.content[2].table.body[0][0].push('\n');
            columns = [];
        }
    }
    
    return docDefinition;
}
</script>
</body>
</html>
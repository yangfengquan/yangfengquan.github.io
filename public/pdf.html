<style>
    #iframeContainer>iframe {
        width: 98%;
        height: 98%;
        position: absolute;
    }
</style>
<div id="pdf">
    <div id="iframeContainer">
        <img src="jquery-easyui-1.10.17/themes/metro/images/loading.gif"/>
        <span>Loading...</span>
    </div>
</div>
<script>
    $(function(){
        const docDefinition = fillDocDefinition(ApiData[CurPlugin].inp, ApiData[CurPlugin].out);
        $.when($.getScript('pdfmake/pdfmake.min.js'),$.getScript('pdfmake/vfs_fonts.js')).done(function(){
            $('#iframeContainer').html("");
            try {
                pdfMake.fonts = {
                    songti: {
                        normal: '长城宋体.TTF',
                        bold: '长城宋体.TTF',
                        italics: '长城宋体.TTF',
                        bolditalics: '长城宋体.TTF'
                    }
                }

                pdfMake.createPdf(docDefinition).getDataUrl().then((dataUrl) => {
                    const targetElement = document.querySelector('#iframeContainer');
                    const iframe = document.createElement('iframe');
                    iframe.src = dataUrl;
                    targetElement.appendChild(iframe);
                    }, err => {
                    console.error(err);
                });  
            } catch (error) {
                alert(error + "\n请稍后重试。");
            } 
        });
    })
    

    
    function fillDocDefinition(data1, data2) {
        let time = new Date();
        var  docDefinition = {
            footer: function(currentPage, pageCount) { return {text: currentPage.toString() + ' / ' + pageCount, alignment: 'center'} },
            content: [
                { text: ['软件：',{decoration: 'underline', color: 'blue', text: 'yangfengquan.github.io', link: 'https://yangfengquan.github.io'}], style: 'right' },
                { text: time.toLocaleDateString(), style: 'right' },
                { 
                    style: 'tablestyle1',
                    table: {
                        widths: [510],
                        heights: [720],
                        body: [[['\n',{ text: '计算报告\n\n', style: 'header' } ]]]
                    }
                }
            ],

            styles: {
                header: {
                    fontSize: 22,
                    alignment: 'center'
                },
                right: {
                    alignment: 'right'
                },
                footer: {
                    alignment: 'right'
                }
            },
            defaultStyle: {
                font: 'songti'
            }
        };

        let columns = [];
        let len = data1.length;
        for (let i = 0; i < len; i++) {
            const item = data1[i];
            columns.push({text: item.name + ': ' + item.value + ' ' + item.unit});
            if (i % 2 != 0 || len - 1 == i) {
                docDefinition.content[2].table.body[0][0].push({columns: columns});
                docDefinition.content[2].table.body[0][0].push('\n');
                columns = [];
            }
        }

        docDefinition.content[2].table.body[0][0].push({text: "---"});
        docDefinition.content[2].table.body[0][0].push('\n');

        let columns1 = [];
        let len1 = data2.length;
        for (let i = 0; i < len1; i++) {
            const item = data2[i];
            columns.push({text: item.name + ': ' + item.value + ' ' + item.unit});
            if (i % 2 != 0 || len1 - 1 == i) {
                docDefinition.content[2].table.body[0][0].push({columns: columns});
                docDefinition.content[2].table.body[0][0].push('\n');
                columns = [];
            }
        }
        
        return docDefinition;
    }
</script>